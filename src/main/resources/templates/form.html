<!DOCTYPE html>
<html lang="pt">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formul√°rio de Venda Profissional</title>
    <link rel="stylesheet" href="/css/form.css" />
  </head>
  <body>
    <div th:object="${produtoModel}" id="saleForm" class="container">
      <h2>Detalhes da Venda</h2>

      <div class="cart-icon">üõí <span id="cartCount">0</span></div>

      <div class="flex-container">
        <div class="section">
          <h3>Informa√ß√µes do Cliente</h3>
          <div class="input-group">
            <label>ID do Cliente:</label>
            <input
              type="text"
              id="clientId"
              placeholder="ID do Cliente"
              onblur="fillClientDetails()"
            />
          </div>
          <div class="input-group">
            <label>Nome:</label>
            <input type="text" id="clientName" placeholder="Nome do Cliente" />
          </div>
          <div class="input-group">
            <label>E-mail:</label>
            <input
              type="email"
              id="clientEmail"
              placeholder="email@exemplo.com"
            />
          </div>
        </div>

        <div class="section" id="productForm">
          <h3>Adicionar Produto</h3>
          <div class="input-group">
            <label>ID do Produto:</label>
            <input
              type="text"
              id="productId"
              placeholder="ID do Produto"
              onblur="fillProductDetails()"
            />
          </div>
          <div class="input-group">
            <label>Produto:</label>
            <input
              type="text"
              id="productName"
              placeholder="Nome do Produto"
              readonly
            />
          </div>
          <div class="input-group">
            <label>Pre√ßo Unit√°rio (Kz):</label>
            <input type="number" id="productPrice" value="500" readonly />
          </div>
          <div class="input-group">
            <label>Quantidade:</label>
            <input type="number" id="productQuantity" value="1" />
          </div>
          <p class="add-product-btn" onclick="addProduct()">
            + Adicionar ao Carrinho
          </p>
        </div>
      </div>

      <div class="section">
        <h3>Produtos no Carrinho</h3>
        <div class="product-table" id="productTable">
          <table>
            <thead>
              <tr>
                <th>Produto</th>
                <th>Quantidade</th>
                <th>A√ß√£o</th>
              </tr>
            </thead>
            <tbody id="productTableBody">
              <!-- Os produtos ser√£o adicionados aqui -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="section">
        <h3>Detalhe de Pagamento</h3>
        <div class="input-group">
          <label>M√©todo de Pagamento:</label>
          <select id="paymentMethod">
            <option>Cart√£o</option>
            <option>Dinheiro</option>
          </select>
        </div>
      </div>

      <div class="total">Total: <span id="totalAmount">Kz 0</span></div>

      <a class="complete-sale-btn" onclick="generateInvoice()">
        Realizar Venda
      </a>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.13/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
      const clientesData = [];
      const produtosData = [];

      async function carregarProdutos() {
        try {
          const responseClientes = await axios.get(
            "http://localhost:8080/cliente/listar"
          );
          const responseProdutos = await axios.get(
            "http://localhost:8080/produto/listar"
          );

          const clientes = responseClientes.data.map((cliente) => ({
            id: cliente.usuario.id,
            nome: cliente.usuario.nome,
            email: cliente.usuario.email,
            cliente_id: cliente.id,
            numero_cliente: cliente.numero_cliente,
          }));

          const produtos = responseProdutos.data.map((produto) => ({
            id: produto.id,
            nome: produto.nome,
            preco: produto.preco,
            numeroProduto: produto.numeroProduto,
          }));

          console.log("Clientes:", clientes);
          // Substitui diretamente os arrays globais
          clientesData.length = 0;
          produtosData.length = 0;
          clientesData.push(...clientes);
          produtosData.push(...produtos);
        } catch (error) {
          console.error("Erro ao carregar os produtos:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        carregarProdutos();
      });

      let products = [];
      let productIds = [];

      function fillClientDetails() {
        const clientId = document.getElementById("clientId").value;
        const clientIdNum = parseInt(clientId, 10);

        const client = clientesData.find(
          (c) => c.numero_cliente === clientIdNum
        );
 
        if (client) {
          document.getElementById("clientName").value = client.nome;
          document.getElementById("clientEmail").value = client.email;
        } else {
          document.getElementById("clientName").value = "";
          document.getElementById("clientEmail").value = "";
        }
      }

      function fillProductDetails() {
        const productId = document.getElementById("productId").value;
        const product = produtosData.find((p) => p.numeroProduto === productId);

        if (product) {
          document.getElementById("productName").value = product.nome;
          document.getElementById("productPrice").value = product.preco;
        } else {
          document.getElementById("productName").value = "";
          document.getElementById("productPrice").value = 500;
        }
      }

      function addProduct() {
        const cartCountElement = document.getElementById("cartCount");

        const productId = document.getElementById("productId").value;
        const productName = document.getElementById("productName").value;
        const productPrice = parseFloat(
          document.getElementById("productPrice").value
        );
        const productQuantity = parseInt(
          document.getElementById("productQuantity").value
        );

        const existingProduct = products.find((p) => p.id === productId);

        if (existingProduct) {
          existingProduct.quantidade += productQuantity;
        } else {
          const product = produtosData.find((p) => p.numeroProduto === productId);

          productIds.push(product.id);
          console.log("productIds", productIds);

          products.push({
            id: productId,
            nome: productName,
            preco: productPrice,
            quantidade: productQuantity,
          });

      
        }

        updateProductTable();
        updateTotalAmount();
      }

      function updateProductTable() {
        document.getElementById("cartCount").value += 1;

        const tbody = document.getElementById("productTableBody");
        tbody.innerHTML = "";

        products.forEach((product) => {
          const row = document.createElement("tr");
          row.innerHTML = `
      <td>${product.nome}</td>
      <td>${product.quantidade}</td>
      <td><button class="remove-product-btn" onclick="removeProduct('${product.id}')">Remover</button></td>
    `;
          tbody.appendChild(row);
        });

        document.getElementById("cartCount").textContent = products.length;

        console.log("Produtos no Carrinho:", products.length);
      }

      function removeProduct(productId) {
        products = products.filter((p) => p.id !== productId);
        updateProductTable();
        updateTotalAmount();
      }

      function updateTotalAmount() {
        const total = products.reduce(
          (sum, product) => sum + product.preco * product.quantidade,
          0
        );
        document.getElementById(
          "totalAmount"
        ).textContent = `Kz ${total.toFixed(2)}`;
      }

      async function cadastrarVenda() {
        try {
          console.log("clienteData", clientesData[0].cliente_id);
          const descricao = "Venda de produtos";
          const dataDaVenda = new Date().toISOString().split("T")[0]; // Formato de data YYYY-MM-DD

          const vendaData = {
            cliente_id: clientesData[0].cliente_id,
            descricao: descricao,
            data_da_venda: dataDaVenda,
            produto_ids: productIds,
            totalDaVenda: products.reduce(
              (sum, product) => sum + product.preco * product.quantidade,
              0
            ),
            // produtos: products.map((product) => ({
            //   produto_id: product.id,
            // })),
          };

          const response = await axios.post(
            "http://localhost:8080/vendas/cadastrar",
            vendaData
          );

          alert("Venda cadastrada com sucesso!");
          console.log("Resposta do servidor:", response.data);

          products = [];
          updateProductTable();
          updateTotalAmount();
        } catch (error) {
          console.log("aaaaaaaaaa", vendaData);

          alert(
            "Erro ao cadastrar a venda. Verifique os dados e tente novamente."
          );
        }
      }

      function generateInvoice() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        doc.setFontSize(16);
        doc.setTextColor(40);
        doc.text("Loja Avante Ilumina√ß√£o", 20, 20);
        doc.setFontSize(12);
        doc.text("Fatura de Venda", 170, 20, null, null, "right");
        doc.setFontSize(10);
        doc.text(
          "Data: " + new Date().toLocaleDateString(),
          170,
          30,
          null,
          null,
          "right"
        );

        // Linha Divis√≥ria
        doc.setLineWidth(0.5);
        doc.line(20, 35, 190, 35);

        const clientName =
          document.getElementById("clientName").value || "Cliente Desconhecido";
        const clientEmail =
          document.getElementById("clientEmail").value || "N√£o fornecido";
        const paymentMethod = document.getElementById("paymentMethod").value;

        doc.setFontSize(12);
        doc.text("Informa√ß√µes do Cliente", 20, 45);
        doc.setFontSize(10);
        doc.text(`Nome: ${clientName}`, 20, 55);
        doc.text(`E-mail: ${clientEmail}`, 20, 65);
        doc.text("Rua do Com√©rcio, 123", 20, 35);
        doc.text(`M√©todo de Pagamento: ${paymentMethod}`, 20, 75);

        doc.setLineWidth(0.5);
        doc.line(20, 80, 190, 80);

        const tableBody = products.map((product, index) => [
          index + 1,
          product.name,
          `Kz ${product.preco.toFixed(2)}`,
          product.quantity,
          `Kz ${(product.preco * product.quantity).toFixed(2)}`,
        ]);

        const tableHeaders = [
          { title: "N¬∫", dataKey: "num" },
          { title: "Produto", dataKey: "name" },
          { title: "Pre√ßo Unit√°rio (Kz)", dataKey: "unitPrice" },
          { title: "Quantidade", dataKey: "quantity" },
          { title: "Subtotal (Kz)", dataKey: "subtotal" },
        ];

        doc.autoTable({
          startY: 90,
          head: [tableHeaders],
          body: tableBody,
          theme: "striped",
          headStyles: { fillColor: [71, 135, 237] },
          styles: { fontSize: 10 },
          columnStyles: {
            0: { cellWidth: 10 },
            1: { cellWidth: 60 },
            2: { cellWidth: 35 },
            3: { cellWidth: 25 },
            4: { cellWidth: 35 },
          },
        });

        const totalAmount = products.reduce(
          (sum, product) => sum + product.price * product.quantity,
          0
        );

        doc.setFontSize(12);
        doc.setFont("Helvetica", "bold");
        doc.text("Total", 140, doc.lastAutoTable.finalY + 10);
        doc.text(
          `Kz ${totalAmount.toFixed(2)}`,
          170,
          doc.lastAutoTable.finalY + 10,
          null,
          null,
          "left"
        );

        // doc.output("dataurlnewwindow");

        cadastrarVenda();
      }
    </script>
  </body>
</html>
